<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChronoTime Mobile Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden;
        }
        #map {
            height: 100vh;
            width: 100vw;
        }
        /* FORCE TUILES ULTRA-AGRESSIF */
        .leaflet-tile-pane,
        .leaflet-tile,
        .leaflet-tile img {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
            z-index: 1 !important;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // CARTE SIMPLE ET GARANTIE
        const map = L.map('map').setView([36.7538, 3.0588], 13);
        
        // OpenStreetMap SIMPLE
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors',
            maxZoom: 19
        }).addTo(map);
        
        // √âcouter les messages du parent
        window.addEventListener('message', function(event) {
            if (event.data.type === 'showRoute') {
                const { start, end, allPoints } = event.data;
                
                console.log('üì® Message re√ßu - affichage route:', start, end);
                console.log('üìç Points complets re√ßus:', allPoints);
                
                // NETTOYAGE COMPLET AVANT NOUVEAU TRAC√â
                map.eachLayer(function(layer) {
                    if (layer instanceof L.Marker || layer instanceof L.Polyline) {
                        map.removeLayer(layer);
                        console.log('üßπ Couche supprim√©e');
                    }
                });
                
                // FORCE REFRESH TUILES AVANT AJOUT
                setTimeout(() => {
                    console.log('üîÑ Force refresh tuiles iframe...');
                    map.invalidateSize();
                    
                    // Ajouter marqueurs avec ic√¥nes color√©es
                    const startMarker = L.marker([start.lat, start.lng], {
                        icon: L.icon({
                            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
                            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                            iconSize: [25, 41],
                            iconAnchor: [12, 41],
                            popupAnchor: [1, -34],
                            shadowSize: [41, 41]
                        })
                    }).addTo(map);
                    startMarker.bindPopup('üèÅ D√©part');
                    
                    const endMarker = L.marker([end.lat, end.lng], {
                        icon: L.icon({
                            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
                            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                            iconSize: [25, 41],
                            iconAnchor: [12, 41],
                            popupAnchor: [1, -34],
                            shadowSize: [41, 41]
                        })
                    }).addTo(map);
                    endMarker.bindPopup('üèÜ Arriv√©e');
                    
                    // ROUTAGE AUTOMATIQUE POUR TRAC√â R√âALISTE
                    console.log('üõ£Ô∏è Calcul route r√©elle entre points...');
                    
                    // UTILISER OPENROUTESERVICE POUR ROUTE R√âELLE
                    const routeUrl = `https://api.openrouteservice.org/v2/directions/driving-car?api_key=5b3ce3597851110001cf6248d4b6c26c8b6e4b3b8f5e4b3b8f5e4b3b&start=${start.lng},${start.lat}&end=${end.lng},${end.lat}`;
                    
                    fetch(routeUrl)
                        .then(response => response.json())
                        .then(data => {
                            console.log('‚úÖ Route calcul√©e par OpenRouteService');
                            
                            if (data.features && data.features[0] && data.features[0].geometry) {
                                // Extraire les coordonn√©es de la route
                                const coordinates = data.features[0].geometry.coordinates;
                                
                                // Convertir en format Leaflet [lat, lng]
                                const routePoints = coordinates.map(coord => [coord[1], coord[0]]);
                                
                                console.log('üõ£Ô∏è Route avec', routePoints.length, 'points calcul√©s');
                                
                                // Cr√©er polyline avec la route r√©elle
                                const route = L.polyline(routePoints, {
                                    color: '#ff0000',
                                    weight: 5,
                                    opacity: 1
                                }).addTo(map);
                                
                                // Centrer sur la route
                                map.fitBounds(route.getBounds(), { padding: [30, 30] });
                                
                                console.log('‚úÖ Route r√©elle affich√©e');
                            } else {
                                throw new Error('Pas de route trouv√©e');
                            }
                        })
                        .catch(error => {
                            console.warn('‚ö†Ô∏è Erreur routage, fallback ligne droite:', error);
                            
                            // FALLBACK - LIGNE DROITE SI ROUTAGE √âCHOUE
                            const route = L.polyline([[start.lat, start.lng], [end.lat, end.lng]], {
                                color: '#ff0000',
                                weight: 5,
                                opacity: 1,
                                dashArray: '10, 10' // Ligne pointill√©e pour indiquer que c'est approximatif
                            }).addTo(map);
                            
                            map.fitBounds(route.getBounds(), { padding: [30, 30] });
                            console.log('‚û°Ô∏è Trac√© approximatif affich√©');
                        });
                    
                    console.log('‚úÖ Route compl√®te affich√©e dans iframe mobile');
                }, 200);
            }
        });
        
        console.log('‚úÖ Carte iframe mobile initialis√©e');
    </script>
</body>
</html>
